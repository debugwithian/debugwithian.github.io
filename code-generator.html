<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Diagram Code Generator</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/2.15.6/js/jsplumb.min.js"></script>
<style>
  #canvas { width: 100%; height: 600px; border: 1px solid #ccc; position: relative; margin-bottom: 20px; background-color: #f8f9fa; }
  .item {
    width: 180px; height: 50px; border: 1px solid #333; border-radius: 5px;
    text-align: center; line-height: 50px; position: absolute; cursor: grab;
    padding: 0 20px; box-sizing: border-box; user-select:none;
  }
  .datasource { background-color: #FFD580; }
  .function { background-color: #80D4FF; }
  .output { background-color: #C0FFC0; }
  .view { background-color: #FFB6C1; }
  .item button { font-size: 0.8rem; }
  .node-content {
    flex: 1;
  }
  .delete-node {
    padding: 0 6px;
    cursor: pointer;
    font-weight: bold;
    margin-left: 5px;
    position: absolute;
    right: 0px;
    top: -12px;
    font-size: 18px;
    color: rgb(195, 30, 30);
  }
</style>
</head>
<body class="p-4">
<a class="btn btn-primary" href="index.html">Back to my Portfolio</a>
<h2 class="mb-3">Diagram to Code Generator</h2>

<div class="row">
  <div class="col-8">
    <div class="mb-3">
      <button class="btn btn-warning me-1" onclick="addItem('Datasource')">Add Datasource</button>
      <button class="btn btn-primary me-1" onclick="addItem('Function')">Add Function</button>
      <button class="btn btn-success me-1" onclick="addItem('Output')">Add Output</button>
      <button class="btn btn-danger me-1" onclick="addItem('View')">Add View</button>
      <button class="btn btn-secondary me-1" onclick="startConnect()">Connect Nodes</button>
      <select id="lang" class="form-select d-inline-block w-auto me-1">
        <option value="php">PHP</option>
        <option value="java">Java</option>
        <option value="C#">C#</option>
        <option value="python">Python</option>
        <option value="js">JavaScript</option>
        <option value="angular">Angular</option>
        <option value="react JS">React JS</option>
        <option value="react Native">React Native</option>
      </select>
      <button class="btn btn-dark" onclick="generateCode()">Generate Code</button>
    </div>
    <div id="canvas"></div>
  </div>

  <div class="col-4">
    <h3 class="mt-3">Generated Code:</h3>
    <textarea id="output" class="form-control" readonly style="height:600px;"></textarea>

    <div class="modal fade" id="nodeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="nodeModalLabel">Configure Node</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="modalBody"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="saveNodeConfig()">Save</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let idCounter = 0;
let connectMode = false;
let sourceNode = null;
let currentNode = null;

// Add Node
function addItem(type){
  const canvas = document.getElementById('canvas');
  const id = 'item'+idCounter++;
  const div = document.createElement('div');
  div.classList.add('item');
  div.id = id;
  div.dataset.type = type;
  div.innerText = type; // placeholder

  if(type==='Datasource') div.classList.add('datasource');
  else if(type==='Function') div.classList.add('function');
  else if(type==='Output') div.classList.add('output');
  else if(type==='View') div.classList.add('view');

  div.style.left = Math.random()*400+'px';
  div.style.top = Math.random()*300+'px';

  div.addEventListener('dblclick', ()=>configureNode(div));

  // Delete button
  const delBtn = document.createElement('span');
  delBtn.innerHTML = '&times;'; // Ã— symbol
  delBtn.className = 'delete-node';
  delBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    deleteNode(id);
  });

  // Active indicator
  div.addEventListener('click', ()=>{
    document.querySelectorAll('.item').forEach(n=>n.classList.remove('active'));
    div.classList.add('active');
    currentNode = div;
  });

  div.appendChild(delBtn);
  canvas.appendChild(div);

  jsPlumb.draggable(div, {containment:'parent'});
  jsPlumb.makeSource(div,{
    filter:".item", anchor:"Continuous", connector:["Flowchart",{cornerRadius:5}],
    connectorStyle:{stroke:"#5c96bc", strokeWidth:2}
  });
  jsPlumb.makeTarget(div,{
    dropOptions:{hoverClass:"dragHover"}, anchor:"Continuous"
  });
}

// Delete Node
function deleteNode(nodeId){
  const node = document.getElementById(nodeId);
  if(!node) return;

  // Remove all connections related to this node
  jsPlumb.deleteConnectionsForElement(node);

  // Remove node
  jsPlumb.remove(nodeId);
  node.remove();
}

// Configure Node Modal
function configureNode(div){
  currentNode = div;
  const type = div.dataset.type;
  let html = '';

  if(type==='Datasource'){
    html += `<label class="form-label">Datasource Type:</label>
      <select id="dsType" class="form-select mb-2">
        <option value="" ${div.dataset.dsType===''?'selected':''}>Select Option</option>
        <option value="SQL" ${div.dataset.dsType==='SQL'?'selected':''}>SQL</option>
        <option value="NoSQL" ${div.dataset.dsType==='NoSQL'?'selected':''}>NoSQL</option>
        <option value="Internal" ${div.dataset.dsType==='Internal'?'selected':''}>Internal</option>
      </select>`;
    html += `<div id="sqlFields" style="display:${div.dataset.dsType==='SQL'?'block':'none'}">
      <label class="form-label">Table Name:</label>
      <input id="tableName" class="form-control mb-2" placeholder="Table Name" value="${div.dataset.table||''}">
      <div id="fieldsContainer"></div>
      <button class="btn btn-sm btn-outline-primary mb-2" type="button" onclick="addField()">Add Field</button>
    </div>`;
    html += `<div id="nosqlFields" style="display:${div.dataset.dsType==='NoSQL'?'block':'none'}">
      <label class="form-label">Datasource Type (NoSQL):</label>
      <input id="nosqlType" class="form-control mb-2" placeholder="Datasource: E.G Redis, DynamoDB etc." value="${div.dataset.nosqlType||''}">
      <div id="keysContainer"></div>
      <button class="btn btn-sm btn-outline-primary mb-2" type="button" onclick="addKey()">Add Key</button>
    </div>`;
    html += `<div id="internalFields" style="display:${div.dataset.dsType==='Internal'?'block':'none'}">
      <label class="form-label">Values:</label>
      <div id="valuesContainer"></div>
      <button class="btn btn-sm btn-outline-primary mb-2" type="button" onclick="addValue()">Add Value</button>
    </div>`;
  } else if(type==='Function'){
    html += `<label class="form-label">Function Name:</label>
      <input id="funcName" class="form-control" placeholder="Function Name" value="${div.innerText}">`;
  } else if(type==='Output'){
    html += `<label class="form-label">Output Format:</label>
      <input id="outputFormat" class="form-control mb-2" placeholder="Output Format" value="${div.dataset.format||'JSON'}">`;
    html += `<label class="form-label">Status Code:</label>
      <input id="statusCode" class="form-control" placeholder="Status Code" value="${div.dataset.status||'200'}">`;
  } else if(type==='View'){
    html += `<label class="form-label">Template Name or HTML Snippet:</label>
      <input id="templateName" class="form-control mb-2" placeholder="Template Name or HTML Snippet" value="${div.dataset.template||''}">`;
    html += `<label class="form-label">Variables to Inject (comma separated):</label>
      <input id="injectVars" class="form-control" placeholder="Variables to Inject" value="${div.dataset.vars||''}">`;
  }

  document.getElementById('modalBody').innerHTML = html;

  // Populate existing fields/keys/values
  if(type==='Datasource'){
    if(div.dataset.fields) JSON.parse(div.dataset.fields).forEach(f=>addField(f));
    if(div.dataset.keys) JSON.parse(div.dataset.keys).forEach(k=>addKey(k));
    if(div.dataset.values) JSON.parse(div.dataset.values).forEach(v=>addValue(v));

    document.getElementById('dsType').addEventListener('change', function(){
      document.getElementById('sqlFields').style.display = this.value==='SQL'?'block':'none';
      document.getElementById('nosqlFields').style.display = this.value==='NoSQL'?'block':'none';
      document.getElementById('internalFields').style.display = this.value==='Internal'?'block':'none';
    });
  }

  new bootstrap.Modal(document.getElementById('nodeModal')).show();
}

// Add Field/Key/Value helpers
function addField(val=''){ const c=document.getElementById('fieldsContainer'); const w=document.createElement('div'); w.className='d-flex mb-1'; const i=document.createElement('input'); i.className='form-control'; i.placeholder='Field Name'; i.value=val; const d=document.createElement('button'); d.className='btn btn-sm btn-danger ms-1'; d.innerText='X'; d.onclick=()=>w.remove(); w.appendChild(i); w.appendChild(d); c.appendChild(w); }
function addKey(val=''){ const c=document.getElementById('keysContainer'); const w=document.createElement('div'); w.className='d-flex mb-1'; const i=document.createElement('input'); i.className='form-control'; i.placeholder='Key Name'; i.value=val; const d=document.createElement('button'); d.className='btn btn-sm btn-danger ms-1'; d.innerText='X'; d.onclick=()=>w.remove(); w.appendChild(i); w.appendChild(d); c.appendChild(w); }
function addValue(val=''){ const c=document.getElementById('valuesContainer'); const w=document.createElement('div'); w.className='d-flex mb-1'; const i=document.createElement('input'); i.className='form-control'; i.placeholder='Value (any type)'; i.value=val; const d=document.createElement('button'); d.className='btn btn-sm btn-danger ms-1'; d.innerText='X'; d.onclick=()=>w.remove(); w.appendChild(i); w.appendChild(d); c.appendChild(w); }

// Save Node
function saveNodeConfig(){
  const type=currentNode.dataset.type;
  if(type==='Datasource'){
    currentNode.dataset.dsType=document.getElementById('dsType').value;
    if(currentNode.dataset.dsType==='SQL'){
      currentNode.dataset.table=document.getElementById('tableName').value;
      const fields=Array.from(document.getElementById('fieldsContainer').querySelectorAll('input')).map(i=>i.value).filter(f=>f);
      currentNode.dataset.fields=JSON.stringify(fields);
      currentNode.innerText=`Datasource(SQL: ${currentNode.dataset.table})`;
    } else if(currentNode.dataset.dsType==='NoSQL'){
      currentNode.dataset.nosqlType=document.getElementById('nosqlType').value;
      const keys=Array.from(document.getElementById('keysContainer').querySelectorAll('input')).map(i=>i.value).filter(k=>k);
      currentNode.dataset.keys=JSON.stringify(keys);
      currentNode.innerText=`Datasource(${currentNode.dataset.nosqlType})`;
    } else {
      const values=Array.from(document.getElementById('valuesContainer').querySelectorAll('input')).map(i=>i.value).filter(v=>v);
      currentNode.dataset.values=JSON.stringify(values);
      currentNode.innerText=`Datasource(Internal: ${values.join(', ')})`;
    }
  } else if(type==='Function'){ currentNode.innerText=document.getElementById('funcName').value; }
  else if(type==='Output'){ currentNode.dataset.format=document.getElementById('outputFormat').value; currentNode.dataset.status=document.getElementById('statusCode').value; currentNode.innerText=`Output(${currentNode.dataset.format}, ${currentNode.dataset.status})`; }
  else if(type==='View'){ currentNode.dataset.template=document.getElementById('templateName').value; currentNode.dataset.vars=document.getElementById('injectVars').value; currentNode.innerText=`View(${currentNode.dataset.template})`; }

  bootstrap.Modal.getInstance(document.getElementById('nodeModal')).hide();
}

// Connect Nodes
function startConnect(){ alert('Click source node, then target node.'); connectMode=true; }
document.getElementById('canvas').addEventListener('click', function(e){
  if(connectMode && e.target.classList.contains('item')){
    if(!sourceNode){ sourceNode=e.target; sourceNode.style.borderColor='red'; }
    else{
      jsPlumb.connect({ source:sourceNode.id,target:e.target.id,connector:["Flowchart",{cornerRadius:5}],anchors:["Continuous","Continuous"],paintStyle:{stroke:"#5c96bc",strokeWidth:2} });
      sourceNode.style.borderColor='#333'; sourceNode=null; connectMode=false;
    }
  }
});

// Generate Code (Groq AI)
async function generateCode(){
  const lang=document.getElementById('lang').value;
  const connections=jsPlumb.getAllConnections();
  const diagramData=[];
  connections.forEach(conn=>{
    const source=document.getElementById(conn.sourceId);
    const target=document.getElementById(conn.targetId);
    diagramData.push({
      from:source.innerText, fromType:source.dataset.type,
      to:target.innerText, toType:target.dataset.type,
      dsType:source.dataset.dsType||'',
      table:source.dataset.table||'',
      fields:source.dataset.fields?JSON.parse(source.dataset.fields):[],
      nosqlType:source.dataset.nosqlType||'',
      keys:source.dataset.keys?JSON.parse(source.dataset.keys):[],
      internalValues:source.dataset.values?JSON.parse(source.dataset.values):[],
      outputFormat:target.dataset.format||'', status:target.dataset.status||'',
      template:source.dataset.template||'', vars:source.dataset.vars||''
    });
  });

  const rulesText=`Datasource rules: Fetch SQL/NoSQL or initialize Internal values
Function rules: Implement as per node
Output rules: Format output and include status
View rules: Render HTML template with variables (only if view is selected in the diagram)
Other notes: ONE full code snippet with comments`;

  const prompt=`Show full code only and provide the best solution based on programming standard: Generate fully working ${lang.toUpperCase()} code snippet from the diagram.
Follow these rules:
${rulesText}
Diagram connections and node details:
${JSON.stringify(diagramData,null,2)}`;

  const response = await fetch('/api/generate-code', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ instructions: prompt })
  });

  const data = await response.json();
  const code = data.code || 'Error generating code';
  document.getElementById('output').value = code;
}
</script>

</body>
</html>
