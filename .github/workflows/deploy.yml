name: üöÄ Auto Deploy to AWS with AI Code Review (Groq)

on:
  pull_request:
    branches:
      - prod_v2
  workflow_dispatch: # Optional manual trigger

jobs:
  ai_code_review:
    name: ü§ñ AI Code Review via Groq
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validate secrets
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          : "${GROQ_API_KEY:?GROQ_API_KEY is not set}"
          : "${PAT_TOKEN:?PAT_TOKEN is not set}"
          echo "‚úÖ Secrets are set."

      - name: Check for code changes & generate diff
        run: |
          git fetch origin prod_v2
          if ! git diff ${{ github.event.before }} ${{ github.sha }} --quiet; then
            git diff ${{ github.event.before }} ${{ github.sha }} | head -n 2000 | head -c 50000 > diff.txt
          else
            echo "No changes detected ‚Äî skipping AI review."
            echo "AI Code Review: ‚úÖ Passed ‚Äî no changes detected." > ai_review_status.txt
            exit 0
          fi

      - name: Run AI Code Review (Groq)
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          set -euo pipefail
          DIFF=$(<diff.txt)
          PAYLOAD=$(jq -n --arg diff "$DIFF" '{
            model: "llama-3.1-8b-instant",
            messages: [
              {role: "system", content: "You are a senior software engineer performing a concise code review. Flag bugs, vulnerabilities, or critical issues."},
              {role: "user", content: "Review the following git diff for potential problems or security issues:\n\n\($diff)"}
            ]
          }')

          RAW_RESPONSE=$(curl -sS --fail https://api.groq.com/openai/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $GROQ_API_KEY" \
            --data-raw "$PAYLOAD") || exit 1

          REVIEW=$(echo "$RAW_RESPONSE" | jq -r '.choices[0].message.content // empty')
          if [ -z "$REVIEW" ]; then
            REVIEW="‚ö†Ô∏è No review returned from Groq."
          fi
          echo "$REVIEW" | tee ai_review_output.txt

      - name: Detect critical issues and write status
        run: |
          if [ ! -s ai_review_output.txt ]; then
            echo "‚ö†Ô∏è AI review output missing or empty."
            echo "AI Code Review: ‚ö†Ô∏è Skipped ‚Äî invalid AI review output." > ai_review_status.txt
          else
            if grep -Eiq "^CRITICAL_ISSUE:" ai_review_output.txt; then
              echo "‚ùå Critical issue detected. Review failed." > ai_review_status.txt
              cat ai_review_output.txt >> ai_review_status.txt
              exit 1
            else
              echo "‚úÖ AI review passed ‚Äî no critical issues detected." > ai_review_status.txt
            fi
          fi

      - name: Post AI Review as PR Comment
        if: always()  # Always post comment
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          if [ ! -s ai_review_status.txt ]; then
            echo "‚ö†Ô∏è AI review status missing ‚Äî skipping posting."
            exit 0
          fi

          COMMENT_BODY=$(jq -Rn --arg text "$(cat ai_review_status.txt | sed 's/["\\<>]/\\&/g')" '$text')

          # Always comment on the PR
          PR_NUMBER=${{ github.event.pull_request.number }}
          API_URL="${{ github.api_url }}/repos/${{ github.repository }}/issues/$PR_NUMBER/comments"

          curl -sS -X POST -H "Authorization: token $PAT_TOKEN" \
               -H "Content-Type: application/json" \
               -d "{\"body\":$COMMENT_BODY}" \
               $API_URL

  deploy:
    name: üöÄ Deploy to AWS (Manual Trigger)
    runs-on: ubuntu-latest
    needs: ai_code_review
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Add SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 3.232.21.89 >> ~/.ssh/known_hosts

      - name: Deploy and restart app on AWS
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@3.232.21.89 "
            cd /home/ubuntu &&
            git fetch origin prod_v2 &&
            git reset --hard origin/prod_v2 &&
            npm install &&
            pm2 restart my-app &&
            echo 'Deployment completed successfully'
          "