name: üöÄ Auto Deploy to AWS with AI Code Review (Groq)

on:
  push:
    branches:
      - prod_v2
  workflow_dispatch:

jobs:
  ai_code_review:
    name: ü§ñ AI Code Review via Groq
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run AI Code Review (Groq)
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          set -euo pipefail
          echo "Running AI Code Review through Groq..."

          git fetch --unshallow || true
          git fetch origin prod_v2

          # Safely generate diff (limit lines and bytes)
          git diff ${{ github.event.before }} ${{ github.sha }} | head -n 2000 | head -c 50000 > diff.txt
          if [ ! -s diff.txt ]; then
            echo "‚ö†Ô∏è No code changes detected ‚Äî skipping AI review."
            exit 0
          fi

          # Read diff safely
          diff=$(<diff.txt)

          # Build payload with jq safely
          payload=$(jq -n --arg diff "$diff" '{
            model: "llama-3.1-8b-instant",
            messages: [
              {
                role: "system",
                content: "You are a senior software engineer performing a concise code review. Flag bugs, vulnerabilities, or critical issues."
              },
              {
                role: "user",
                content: "Review the following git diff for potential problems or security issues:\n\n\($diff)"
              }
            ]
          }') || exit 1

          # Send payload to Groq API with error handling
          RAW_RESPONSE=$(curl -sS --fail https://api.groq.com/openai/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $GROQ_API_KEY" \
            --data-raw "$payload") || exit 1

          REVIEW=$(echo "$RAW_RESPONSE" | jq -r '.choices[0].message.content // empty')

          echo "---- AI Code Review (Groq) ----"
          if [ -z "$REVIEW" ]; then
            echo "‚ö†Ô∏è No valid review returned from Groq."
            exit 0
          fi

          echo "$REVIEW" | tee ai_review_output.txt

          # Stop deployment if critical issue detected
          if grep -iq "critical issue" <<< "$REVIEW"; then
            echo "‚ùå Critical issue detected. Stopping deployment."
            exit 1
          fi

      - name: Post AI Review as GitHub Commit Comment
        if: success() && github.event_name == 'push'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Posting AI review as commit comment..."
          COMMENT_BODY=$(cat ai_review_output.txt | sed 's/"/\\"/g')
          API_URL="https://api.github.com/repos/${{ github.repository }}/commits/${{ github.sha }}/comments"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"body\":\"**AI Code Review:**\n\n$COMMENT_BODY\"}" \
            $API_URL)
          if [ "$HTTP_STATUS" -ne 201 ]; then
            echo "‚ö†Ô∏è Failed to post commit comment, HTTP status: $HTTP_STATUS"
          fi

  deploy:
    name: üöÄ Deploy to AWS (Manual Trigger)
    runs-on: ubuntu-latest
    needs: ai_code_review
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Add SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 3.232.21.89 >> ~/.ssh/known_hosts

      - name: Deploy and restart app on AWS
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@3.232.21.89 "
            cd /home/ubuntu &&
            git fetch origin prod_v2 &&
            git reset --hard origin/prod_v2 &&
            npm install &&
            pm2 restart all
          "
