name: ðŸš€ Auto Deploy to AWS with AI Code Review (Groq)

on:
  pull_request:
    branches:
      - prod_v2
    types:
      - opened
      - synchronize
      - reopened
  push:
    branches:
      - prod_v2
  workflow_dispatch:

jobs:
  ai_code_review:
    name: ðŸ¤– AI Code Review via Groq
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validate secrets
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          : "${GROQ_API_KEY:?GROQ_API_KEY is not set}"
          : "${PAT_TOKEN:?PAT_TOKEN is not set}"
          echo "âœ… Secrets validated."

      - name: Generate Git Diff for PR branch
        if: github.event_name == 'pull_request'
        run: |
          set -euo pipefail
          git fetch origin prod_v2
          git fetch origin +refs/pull/${{ github.event.pull_request.number }}/head:pr_branch
          git checkout pr_branch
          BASE=$(git merge-base HEAD origin/prod_v2)

          if ! git diff $BASE HEAD --quiet; then
            git diff $BASE HEAD | head -n 2000 | head -c 50000 > diff.txt
          else
            echo "No changes detected â€” skipping AI review."
            echo "âœ… No Issue on code" > ai_review_output.txt
          fi

      - name: Analyze AI Review & Output JSON
        run: |
          set -euo pipefail
          REVIEW_FILE="ai_review_output.txt"   # or ai_review_output.json if you use the JSON output from Groq
          STATUS_FILE="ai_review_status.json"
          touch "$REVIEW_FILE"

          if [ ! -s "$REVIEW_FILE" ]; then
            # No issues detected
            STATUS='{"status":"PASSED","body":"No issues detected."}'
          elif grep -Eiq "^CRITICAL_ISSUE" "$REVIEW_FILE"; then
            # Critical issue found
            BODY=$(cat "$REVIEW_FILE")
            STATUS=$(jq -n --arg body "$BODY" '{"status":"CRITICAL","body":$body}')
          elif grep -Eiq "needs improvement|suggestion|warning" "$REVIEW_FILE"; then
            # Warnings or suggested improvements
            BODY=$(cat "$REVIEW_FILE")
            STATUS=$(jq -n --arg body "$BODY" '{"status":"IMPROVEMENTS","body":$body}')
          else
            # Passed but some comments exist
            BODY=$(cat "$REVIEW_FILE")
            STATUS=$(jq -n --arg body "$BODY" '{"status":"PASSED","body":$body}')
          fi

          echo "$STATUS" | tee "$STATUS_FILE"
          # Export for downstream jobs
          echo "status=$(jq -r '.status' <<< "$STATUS")" >> $GITHUB_OUTPUT


      - name: Post AI Review as PR Comment
        if: github.event_name == 'pull_request'
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          set -euo pipefail
          REVIEW_CONTENT=$(cat ai_review_status.txt)
          JSON_BODY=$(jq -Rn --arg text "$REVIEW_CONTENT" '{"body": $text}')

          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          API_URL="https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments"

          curl -sS -X POST \
               -H "Authorization: token $PAT_TOKEN" \
               -H "Content-Type: application/json" \
               -d "$JSON_BODY" \
               $API_URL

  deploy:
    name: ðŸš€ Deploy to AWS
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/prod_v2'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Add SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 3.232.21.89 >> ~/.ssh/known_hosts

      - name: Deploy and restart app on AWS
        run: |
          set -euo pipefail
          ssh -i ~/.ssh/id_rsa ubuntu@3.232.21.89 "
            cd /home/ubuntu &&
            git fetch origin prod_v2 &&
            git reset --hard origin/prod_v2 &&
            npm install &&
            pm2 restart all &&
            echo 'Deployment completed successfully'
          "
