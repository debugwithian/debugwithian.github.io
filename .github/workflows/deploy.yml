name: ðŸš€ Auto Deploy to AWS with AI Code Review (Groq)

on:
  pull_request:
    branches:
      - prod_v2
    types:
      - opened
      - synchronize
      - reopened
  push:
    branches:
      - prod_v2
  workflow_dispatch:

jobs:
  ai_code_review:
    name: ðŸ¤– AI Code Review via Groq
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validate secrets
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          : "${GROQ_API_KEY:?GROQ_API_KEY is not set}"
          : "${PAT_TOKEN:?PAT_TOKEN is not set}"
          echo "âœ… Secrets validated."

      - name: Generate Git Diff for PR branch
        id: generate_diff
        run: |
          set -euo pipefail
          git fetch origin prod_v2
          git fetch origin +refs/pull/${{ github.event.pull_request.number }}/head:pr_branch
          git checkout pr_branch
          BASE=$(git merge-base HEAD origin/prod_v2)

          if ! git diff $BASE HEAD --quiet; then
            git diff $BASE HEAD > diff.txt
            echo "diff_exists=true" >> $GITHUB_OUTPUT
          else
            echo '{"status":"PASSED","body":"No issues detected."}' > ai_review_output.txt
            echo "diff_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Run AI Code Review (Groq)
        if: steps.generate_diff.outputs.diff_exists == 'true'
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          set -euo pipefail
          DIFF=$(<diff.txt)
          PAYLOAD=$(jq -n --arg diff "$DIFF" '{
            model: "llama-3.1-8b-instant",
            messages: [
              {
                role: "system",
                content: "You are a senior software engineer performing a strict code review. Your ONLY output must be a valid JSON array of objects in the format: [{\"status\":\"CRITICAL_ISSUE|IMPROVEMENTS|PASSED\",\"body\":\"Comment here\"}]. Include the code blocks affected by CRITICAL or IMPROVEMENTS. If syntax errors exist, status must be CRITICAL_ISSUE."
              },
              {
                role: "user",
                content: ("Review the following git diff for potential problems (logic, syntax, style, performance, security).\n\n" + $diff)
              }
            ]
          }')

          RAW_RESPONSE=$(curl -sS --fail https://api.groq.com/openai/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $GROQ_API_KEY" \
            --data-raw "$PAYLOAD") || exit 1

          # Extract content
          REVIEW_RAW=$(echo "$RAW_RESPONSE" | jq -r '.choices[0].message.content // empty')
          REVIEW_RAW=$(echo "$REVIEW_RAW" | tr -d '\n' | sed 's/\\n/ /g' | sed 's/\\"/"/g' | sed 's/^"//;s/"$//')
          
          # If AI did not return anything, mark as PASSED
          if [ -z "$REVIEW_RAW" ]; then
            REVIEW_RAW='[{"status":"PASSED","body":"No issues detected."}]'
          fi

          echo "$REVIEW_RAW" > ai_review_output.txt

      - name: Analyze AI Review & Post PR Comment
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          set -euo pipefail

          REVIEW_FILE="ai_review_output.txt"
          STATUS_FILE="ai_review_status.txt"
          
          # Read AI output
          RAW=$(cat "$REVIEW_FILE")
          
          # Wrap concatenated JSON objects into an array if needed
          if ! echo "$RAW" | jq empty 2>/dev/null; then
            RAW=$(echo "$RAW" | sed 's/}{/},{/g' | awk '{print "[" $0 "]"}')
          fi
          
          # Merge statuses: CRITICAL_ISSUE > IMPROVEMENTS > PASSED
          STATUS=$(echo "$RAW" | jq -r 'map(.status) | if index("CRITICAL_ISSUE") then "CRITICAL_ISSUE" elif index("IMPROVEMENTS") then "IMPROVEMENTS" else "PASSED" end')
          
          # Combine all bodies safely
          BODY=$(echo "$RAW" | jq -r 'map(.body) | join("\n\n")')
          
          # Normalize status for workflow logic
          case "$STATUS" in
            CRITICAL_ISSUE) NORMALIZED="CRITICAL" ;;
            IMPROVEMENTS)   NORMALIZED="IMPROVEMENTS" ;;
            PASSED)         NORMALIZED="PASSED" ;;
            *)              NORMALIZED="PASSED" ;;
          esac
          
          # Save status and body to file
          {
            echo "Status: $NORMALIZED"
            echo ""
            echo "$BODY"
          } > "$STATUS_FILE"
          
          # Safely escape content for GitHub API
          COMMENT=$(cat "$STATUS_FILE")
          JSON_BODY=$(jq -n --arg text "$COMMENT" '{body: $text}')
          
          # PR info
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          API_URL="https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments"
          
          # Post PR comment
          curl -sS -X POST \
               -H "Authorization: token $PAT_TOKEN" \
               -H "Content-Type: application/json" \
               -d "$JSON_BODY" \
               "$API_URL"
          
          # Fail workflow if CRITICAL issues exist
          if [[ "$NORMALIZED" == "CRITICAL" ]]; then
            echo "CRITICAL issues detected. Blocking merge."
            exit 1
          fi

  deploy:
    name: ðŸš€ Deploy to AWS
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/prod_v2'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Add SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 3.232.21.89 >> ~/.ssh/known_hosts

      - name: Deploy and restart app on AWS
        run: |
          set -euo pipefail
          ssh -i ~/.ssh/id_rsa ubuntu@3.232.21.89 "
            cd /home/ubuntu &&
            git fetch origin prod_v2 &&
            git reset --hard origin/prod_v2 &&
            npm install &&
            pm2 restart all &&
            echo 'Deployment completed successfully'
          "
