name: ðŸš€ Auto Deploy to AWS with AI Code Review (Groq)

on:
  pull_request:
    branches:
      - prod_v2
    types: [opened, synchronize, reopened]
  push:
    branches:
      - prod_v2
  workflow_dispatch:

jobs:
  # ai_code_review:
  #   name: ðŸ¤– AI Code Review
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'pull_request' && github.event.pull_request.merged == false
  #   outputs:
  #     review_status: ${{ steps.set_review_status.outputs.review_status }}

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0

  #     - name: Install dependencies
  #       run: sudo apt-get update && sudo apt-get install -y jq curl

  #     - name: Validate secrets
  #       env:
  #         GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
  #         PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
  #       run: |
  #         : "${GROQ_API_KEY:?GROQ_API_KEY is not set}"
  #         : "${PAT_TOKEN:?PAT_TOKEN is not set}"
  #         echo "âœ… Secrets validated."

  #     - name: Generate Git Diff for PR branch
  #       id: generate_diff
  #       run: |
  #         set -e
  #         git fetch origin prod_v2
  #         git fetch origin +refs/pull/${{ github.event.pull_request.number }}/head:pr_branch
  #         git checkout pr_branch
  #         BASE=$(git merge-base HEAD origin/prod_v2)
  #         if ! git diff $BASE HEAD --quiet; then
  #           git diff $BASE HEAD > diff.txt
  #           echo "diff_exists=true" >> "$GITHUB_OUTPUT"
  #         else
  #           echo "No issues detected." > ai_review_output.txt
  #           echo "diff_exists=false" >> "$GITHUB_OUTPUT"
  #         fi

  #     - name: Run AI Code Review (Groq)
  #       id: run_ai
  #       if: steps.generate_diff.outputs.diff_exists == 'true'
  #       env:
  #         GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
  #       run: |
  #         set -e
  #         DIFF=$(<diff.txt)
  #         PROMPT="You are a strict senior engineer. Review the following git diff for logic, security, syntax, performance. Return Markdown with a final status: PASSED, NEEDS IMPROVEMENTS, or CRITICAL.\n\n$DIFF"
  #         AI_COMMENT=$(curl -sS --fail https://api.groq.com/openai/v1/chat/completions \
  #           -H "Content-Type: application/json" \
  #           -H "Authorization: Bearer $GROQ_API_KEY" \
  #           -d "$(jq -n --arg prompt "$PROMPT" '{model: "llama-3.1-8b-instant", messages: [{role: "user", content: $prompt}]}')" \
  #           | jq -r '.choices[0].message.content // "No issues detected."')
  #         printf "%s" "$AI_COMMENT" > ai_review_output.txt

  #     - name: Analyze AI Review
  #       id: set_review_status
  #       run: |
  #         set -e
  #         AI_COMMENT=$(<ai_review_output.txt)
  #         STATUS="IMPROVEMENTS"
  #         if echo "$AI_COMMENT" | grep -iq "critical"; then
  #           if echo "$AI_COMMENT" | grep -iqE "no critical|not critical"; then
  #             STATUS="IMPROVEMENTS"
  #           else
  #             STATUS="CRITICAL_ISSUE"
  #           fi
  #         elif echo "$AI_COMMENT" | grep -iq "passed"; then
  #           STATUS="PASSED"
  #         fi
  #         echo "$AI_COMMENT" > ai_review_status.txt
  #         echo "review_status=$STATUS" >> "$GITHUB_OUTPUT"

  #     - name: Post Review to PR
  #       env:
  #         PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
  #       run: |
  #         COMMENT=$(<ai_review_status.txt)
  #         JSON=$(jq -Rs --arg c "$COMMENT" '{body: $c}')
  #         curl -sS -X POST \
  #              -H "Authorization: token $PAT_TOKEN" \
  #              -H "Content-Type: application/json" \
  #              -d "$JSON" \
  #              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"

      # - name: Fail on Critical
      #   if: steps.set_review_status.outputs.review_status == 'CRITICAL_ISSUE'
      #   run: |
      #     echo "âŒ Critical issues found. Blocking."
      #     exit 1

  deploy_dynamic_env:
    name: ðŸŒ Create Dynamic Branch Environment
    runs-on: ubuntu-latest
    # needs: ai_code_review
    if: github.event_name == 'pull_request' 
    # && needs.ai_code_review.outputs.review_status != 'CRITICAL_ISSUE'

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Add SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 3.232.21.89 >> ~/.ssh/known_hosts

      - name: Deploy Dynamic Branch Environment
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@3.232.21.89 "bash -c '
            set -e

            # Determine branch and domain
            BRANCH=\"${GITHUB_HEAD_REF:-${GITHUB_REF##*/}}\"
            DOMAIN=\"\$BRANCH.debugwithian.com\"

            # Find available port starting from 8090
            PORT=\$(comm -23 <(seq 8090 8500 | sort) <(sudo lsof -i -P -n | grep LISTEN | awk '\''{print \$9}'\'' | sed '\''s/.*://'\'' | sort -u) | head -n 1)
            echo \"Using port: \$PORT for branch: \$BRANCH\"

            NGINX_FILE=\"/etc/nginx/sites-available/\$BRANCH.conf\"

            # Generate a temporary dummy Nginx config for certbot
            sudo bash -c \"printf '%s\n' \
              'server {' \
              '    listen 80;' \
              '    listen [::]:80;' \
              '    server_name \$DOMAIN;' \
              '    location / {' \
              '        return 200 \"OK\";' \
              '    }' \
              '}' \
              > \$NGINX_FILE\"

            sudo ln -sf \$NGINX_FILE /etc/nginx/sites-enabled/
            sudo systemctl reload nginx || true

            # Request SSL certificate
            sudo certbot --nginx -d \$DOMAIN --non-interactive --agree-tos -m ddiamanterbitwilio@gmail.com || true

            # Overwrite Nginx config with real proxy config
            sudo bash -c \"printf '%s\n' \
              'server {' \
              '    listen 80;' \
              '    listen [::]:80;' \
              '    server_name \$DOMAIN;' \
              '    return 301 https://\$host\$request_uri;' \
              '}' \
              'server {' \
              '    listen 443 ssl http2;' \
              '    listen [::]:443 ssl http2;' \
              '    server_name \$DOMAIN;' \
              '    ssl_certificate /etc/letsencrypt/live/\$DOMAIN/fullchain.pem;' \
              '    ssl_certificate_key /etc/letsencrypt/live/\$DOMAIN/privkey.pem;' \
              '    include /etc/letsencrypt/options-ssl-nginx.conf;' \
              '    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;' \
              '    location / {' \
              '        proxy_pass http://localhost:\$PORT;' \
              '        proxy_set_header Host \$host;' \
              '        proxy_set_header X-Real-IP \$remote_addr;' \
              '        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;' \
              '        proxy_set_header X-Forwarded-Proto \$scheme;' \
              '    }' \
              '}' \
              > \$NGINX_FILE\"

            sudo ln -sf \$NGINX_FILE /etc/nginx/sites-enabled/
            sudo systemctl reload nginx

            # Clone or update branch
            cd /home/ubuntu
            if [ ! -d \$BRANCH ]; then
                git clone -b \$BRANCH https://github.com/${GITHUB_REPOSITORY} \$BRANCH
            else
                cd \$BRANCH
                git fetch origin \$BRANCH
                git reset --hard origin/\$BRANCH
            fi

            # Install and start app
            cd /home/ubuntu/\$BRANCH
            npm install
            pm2 delete \$BRANCH || true
            pm2 start npm --name \$BRANCH -- run start -- --port=\$PORT
            pm2 save
          '"

  deploy:
    name: ðŸš€ Deploy to AWS (prod_v2)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/prod_v2'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Add SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 3.232.21.89 >> ~/.ssh/known_hosts

      - name: Deploy and restart app on AWS
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@3.232.21.89 '
            set -e
            cd /home/ubuntu
            git fetch origin prod_v2
            git reset --hard origin/prod_v2
            npm install
            pm2 restart all
            pm2 save
            echo "âœ… Production deployment completed successfully"
          '
